{"version":3,"file":"interactive-map.js","names":["React","useContext","useRef","useMemo","useEffect","useImperativeHandle","forwardRef","PropTypes","StaticMap","getViewport","MAPBOX_LIMITS","TransitionManager","MapContext","MapContextProvider","EventManager","MapController","useIsomorphicLayoutEffect","getTerrainElevation","propTypes","Object","assign","maxZoom","number","minZoom","maxPitch","minPitch","onViewStateChange","func","onViewportChange","onInteractionStateChange","transitionDuration","oneOfType","string","transitionInterpolator","object","transitionInterruption","transitionEasing","onTransitionStart","onTransitionInterrupt","onTransitionEnd","scrollZoom","bool","dragPan","dragRotate","doubleClickZoom","touchZoom","touchRotate","keyboard","onHover","onClick","onDblClick","onContextMenu","onMouseDown","onMouseMove","onMouseUp","onTouchStart","onTouchMove","onTouchEnd","onMouseEnter","onMouseLeave","onMouseOut","onWheel","touchAction","eventRecognizerOptions","clickRadius","interactiveLayerIds","array","getCursor","controller","instanceOf","getDefaultCursor","isDragging","isHovering","defaultProps","onNativeClick","event","preventDefault","normalizeEvent","lngLat","offsetCenter","x","y","Number","isFinite","pos","point","viewport","location","unproject","targetZ","meterOffset","getFeatures","map","queryParams","size","props","layers","queryRenderedFeatures","onEvent","callbackName","call","onPointerDown","pointerType","onPointerUp","onPointerMove","state","features","Boolean","length","isEntering","isExiting","setState","onPointerClick","callbacks","isDoubleClickEnabled","type","push","filter","forEach","cb","getRefHandles","staticMapRef","getMap","current","InteractiveMap","ref","parentContext","eventManager","recognizerOptions","eventCanvasRef","_thisRef","width","height","thisRef","newState","style","cursor","inRender","viewportUpdateRequested","stateUpdateRequested","handleViewportChange","viewState","interactionState","oldViewState","defineProperty","get","context","container","handleInteractionStateChange","updateControllerOpts","setOptions","isInteractive","onStateChange","onResize","setElement","on","pointerdown","bind","pointermove","pointerup","pointerleave","click","anyclick","dblclick","wheel","contextmenu","destroy","eventCanvasStyle","position","_child","supported"],"sources":["../../../src/components/interactive-map.js"],"sourcesContent":["import * as React from 'react';\nimport {useContext, useRef, useMemo, useEffect, useImperativeHandle, forwardRef} from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport StaticMap, {getViewport} from './static-map';\nimport {MAPBOX_LIMITS} from '../utils/map-state';\n\nimport TransitionManager from '../utils/transition-manager';\nimport MapContext, {MapContextProvider} from './map-context';\n\nimport {EventManager} from 'mjolnir.js';\nimport MapController from '../utils/map-controller';\nimport useIsomorphicLayoutEffect from '../utils/use-isomorphic-layout-effect';\nimport {getTerrainElevation} from '../utils/terrain';\n\nconst propTypes = Object.assign({}, StaticMap.propTypes, {\n  // Additional props on top of StaticMap\n\n  /** Viewport constraints */\n  // Max zoom level\n  maxZoom: PropTypes.number,\n  // Min zoom level\n  minZoom: PropTypes.number,\n  // Max pitch in degrees\n  maxPitch: PropTypes.number,\n  // Min pitch in degrees\n  minPitch: PropTypes.number,\n\n  // Callbacks fired when the user interacted with the map. The object passed to the callbacks\n  // contains viewport properties such as `longitude`, `latitude`, `zoom` etc.\n  onViewStateChange: PropTypes.func,\n  onViewportChange: PropTypes.func,\n  onInteractionStateChange: PropTypes.func,\n\n  /** Viewport transition **/\n  // transition duration for viewport change\n  transitionDuration: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  // TransitionInterpolator instance, can be used to perform custom transitions.\n  transitionInterpolator: PropTypes.object,\n  // type of interruption of current transition on update.\n  transitionInterruption: PropTypes.number,\n  // easing function\n  transitionEasing: PropTypes.func,\n  // transition status update functions\n  onTransitionStart: PropTypes.func,\n  onTransitionInterrupt: PropTypes.func,\n  onTransitionEnd: PropTypes.func,\n\n  /** Enables control event handling */\n  // Scroll to zoom\n  scrollZoom: PropTypes.oneOfType([PropTypes.bool, PropTypes.object]),\n  // Drag to pan\n  dragPan: PropTypes.oneOfType([PropTypes.bool, PropTypes.object]),\n  // Drag to rotate\n  dragRotate: PropTypes.oneOfType([PropTypes.bool, PropTypes.object]),\n  // Double click to zoom\n  doubleClickZoom: PropTypes.bool,\n  // Multitouch zoom\n  touchZoom: PropTypes.oneOfType([PropTypes.bool, PropTypes.object]),\n  // Multitouch rotate\n  touchRotate: PropTypes.oneOfType([PropTypes.bool, PropTypes.object]),\n  // Keyboard\n  keyboard: PropTypes.oneOfType([PropTypes.bool, PropTypes.object]),\n\n  /** Event callbacks */\n  onHover: PropTypes.func,\n  onClick: PropTypes.func,\n  onDblClick: PropTypes.func,\n  onContextMenu: PropTypes.func,\n  onMouseDown: PropTypes.func,\n  onMouseMove: PropTypes.func,\n  onMouseUp: PropTypes.func,\n  onTouchStart: PropTypes.func,\n  onTouchMove: PropTypes.func,\n  onTouchEnd: PropTypes.func,\n  onMouseEnter: PropTypes.func,\n  onMouseLeave: PropTypes.func,\n  onMouseOut: PropTypes.func,\n  onWheel: PropTypes.func,\n\n  /** Custom touch-action CSS for the event canvas. Defaults to 'none' */\n  touchAction: PropTypes.string,\n\n  /** Custom hammer.js recognizer options */\n  eventRecognizerOptions: PropTypes.object,\n\n  /** Radius to detect features around a clicked point. Defaults to 0. */\n  clickRadius: PropTypes.number,\n\n  /** List of layers that are interactive */\n  interactiveLayerIds: PropTypes.array,\n\n  /** Accessor that returns a cursor style to show interactive state */\n  getCursor: PropTypes.func,\n\n  // A map control instance to replace the default map controller\n  // The object must expose a method: `setOptions(opts)`\n  controller: PropTypes.instanceOf(MapController)\n});\n\nconst getDefaultCursor = ({isDragging, isHovering}) =>\n  isDragging ? 'grabbing' : isHovering ? 'pointer' : 'grab';\n\nconst defaultProps = Object.assign(\n  {},\n  StaticMap.defaultProps,\n  MAPBOX_LIMITS,\n  TransitionManager.defaultProps,\n  {\n    onViewStateChange: null,\n    onViewportChange: null,\n    onClick: null,\n    onNativeClick: null,\n    onHover: null,\n    onContextMenu: event => event.preventDefault(),\n\n    scrollZoom: true,\n    dragPan: true,\n    dragRotate: true,\n    doubleClickZoom: true,\n    touchZoom: true,\n    touchRotate: false,\n    keyboard: true,\n\n    touchAction: 'none',\n    eventRecognizerOptions: {},\n    clickRadius: 0,\n    getCursor: getDefaultCursor\n  }\n);\n\n/* Event handlers */\nfunction normalizeEvent(event) {\n  if (event.lngLat || !event.offsetCenter) {\n    return event;\n  }\n\n  const {\n    offsetCenter: {x, y}\n  } = event;\n  // https://github.com/visgl/react-map-gl/issues/1449\n  // TODO - fix in mjolnir.js\n  if (!Number.isFinite(x) || !Number.isFinite(y)) {\n    return event;\n  }\n  const pos = [x, y];\n\n  event.point = pos;\n\n  const {viewport} = this;\n  const location = viewport.unproject(pos, {targetZ: viewport.meterOffset[2]});\n  event.lngLat = [location[0], location[1]];\n\n  return event;\n}\n\nfunction getFeatures(pos) {\n  const {map} = this;\n\n  if (!map || !pos) {\n    return null;\n  }\n\n  const queryParams = {};\n  const size = this.props.clickRadius;\n\n  if (this.props.interactiveLayerIds) {\n    queryParams.layers = this.props.interactiveLayerIds;\n  }\n\n  try {\n    // This may fail if map is still loading\n    return map.queryRenderedFeatures(\n      size\n        ? // Radius enables point features, like marker symbols, to be clicked.\n          [\n            [pos[0] - size, pos[1] + size],\n            [pos[0] + size, pos[1] - size]\n          ]\n        : pos,\n      queryParams\n    );\n  } catch {\n    return null;\n  }\n}\n\nfunction onEvent(callbackName, event) {\n  const func = this.props[callbackName];\n  if (func) {\n    func(normalizeEvent.call(this, event));\n  }\n}\n\nfunction onPointerDown(event) {\n  onEvent.call(this, event.pointerType === 'touch' ? 'onTouchStart' : 'onMouseDown', event);\n}\n\nfunction onPointerUp(event) {\n  onEvent.call(this, event.pointerType === 'touch' ? 'onTouchEnd' : 'onMouseUp', event);\n}\n\n// eslint-disable-next-line complexity\nfunction onPointerMove(event) {\n  onEvent.call(this, event.pointerType === 'touch' ? 'onTouchMove' : 'onMouseMove', event);\n\n  if (!this.state.isDragging) {\n    const {onHover, interactiveLayerIds} = this.props;\n    let features;\n    event = normalizeEvent.call(this, event);\n    if (interactiveLayerIds || onHover) {\n      features = getFeatures.call(this, event.point);\n    }\n\n    const isHovering = Boolean(interactiveLayerIds && features && features.length > 0);\n    const isEntering = isHovering && !this.state.isHovering;\n    const isExiting = !isHovering && this.state.isHovering;\n\n    if (onHover || isEntering) {\n      event.features = features;\n\n      // backward compatibility: v3 `onHover` interface\n      if (onHover) {\n        onHover(event);\n      }\n    }\n\n    if (isEntering) {\n      onEvent.call(this, 'onMouseEnter', event);\n    }\n    if (isExiting) {\n      onEvent.call(this, 'onMouseLeave', event);\n    }\n    if (isEntering || isExiting) {\n      this.setState({isHovering});\n    }\n  }\n}\n\nfunction onPointerClick(event) {\n  const {onClick, onNativeClick, onDblClick, doubleClickZoom} = this.props;\n  let callbacks = [];\n  const isDoubleClickEnabled = onDblClick || doubleClickZoom;\n\n  // `click` is only fired on single click. `anyclick` is fired twice if double clicking.\n  // `click` has a delay period after pointer up that prevents it from firing when\n  // double clicking. `anyclick` is always fired immediately after pointer up.\n  // If double click is turned off by the user, we want to immediately fire the\n  // onClick event. Otherwise, we wait to make sure it's a single click.\n  switch (event.type) {\n    case 'anyclick':\n      callbacks.push(onNativeClick);\n      if (!isDoubleClickEnabled) {\n        callbacks.push(onClick);\n      }\n      break;\n\n    case 'click':\n      if (isDoubleClickEnabled) {\n        callbacks.push(onClick);\n      }\n      break;\n\n    default:\n  }\n\n  callbacks = callbacks.filter(Boolean);\n\n  if (callbacks.length) {\n    event = normalizeEvent.call(this, event);\n    // backward compatibility: v3 `onClick` interface\n    event.features = getFeatures.call(this, event.point);\n    callbacks.forEach(cb => cb(event));\n  }\n}\n/* End of event handers */\n\nfunction getRefHandles(staticMapRef) {\n  return {\n    getMap: staticMapRef.current && staticMapRef.current.getMap,\n    queryRenderedFeatures: staticMapRef.current && staticMapRef.current.queryRenderedFeatures\n  };\n}\n\n/* eslint-disable max-statements */\nconst InteractiveMap = forwardRef((props, ref) => {\n  const parentContext = useContext(MapContext);\n  const controller = useMemo(() => props.controller || new MapController(), []);\n  const eventManager = useMemo(\n    () =>\n      new EventManager(null, {\n        touchAction: props.touchAction,\n        recognizerOptions: props.eventRecognizerOptions\n      }),\n    []\n  );\n  const eventCanvasRef = useRef(null);\n  const staticMapRef = useRef(null);\n\n  // Event handlers are registered once but need access to the latest props\n  // This is an anti-pattern, though it maintains a persistent reference to the latest props/state of this component\n  const _thisRef = useRef({\n    width: 0,\n    height: 0,\n    state: {\n      isHovering: false,\n      isDragging: false\n    }\n  });\n  const thisRef = _thisRef.current;\n  thisRef.props = props;\n  thisRef.map = staticMapRef.current && staticMapRef.current.getMap();\n  thisRef.setState = newState => {\n    thisRef.state = {...thisRef.state, ...newState};\n    eventCanvasRef.current.style.cursor = props.getCursor(thisRef.state);\n  };\n\n  let inRender = true;\n  let viewportUpdateRequested;\n  let stateUpdateRequested;\n\n  const handleViewportChange = (viewState, interactionState, oldViewState) => {\n    if (inRender) {\n      // Do not call the callbacks during render - may result in \"cannot update during an existing state transition\" error.\n      // Defer the update until after render\n      viewportUpdateRequested = [viewState, interactionState, oldViewState];\n      return;\n    }\n    const {onViewStateChange, onViewportChange} = thisRef.props;\n\n    /* eslint-disable accessor-pairs */\n    Object.defineProperty(viewState, 'position', {\n      get: () => [0, 0, getTerrainElevation(thisRef.map, viewState)]\n    });\n\n    if (onViewStateChange) {\n      onViewStateChange({viewState, interactionState, oldViewState});\n    }\n    if (onViewportChange) {\n      onViewportChange(viewState, interactionState, oldViewState);\n    }\n  };\n\n  useImperativeHandle(ref, () => getRefHandles(staticMapRef), []);\n\n  const context = useMemo(\n    () => ({\n      ...parentContext,\n      eventManager,\n      container: parentContext.container || eventCanvasRef.current\n    }),\n    [parentContext, eventCanvasRef.current]\n  );\n  context.onViewportChange = handleViewportChange;\n  context.viewport = parentContext.viewport || getViewport(thisRef);\n  thisRef.viewport = context.viewport;\n\n  const handleInteractionStateChange = interactionState => {\n    const {isDragging = false} = interactionState;\n    if (isDragging !== thisRef.state.isDragging) {\n      thisRef.setState({isDragging});\n    }\n\n    if (inRender) {\n      // Do not call the callbacks during render - may result in \"cannot update during an existing state transition\" error.\n      // Defer the update until after render\n      stateUpdateRequested = interactionState;\n      return;\n    }\n\n    const {onInteractionStateChange} = thisRef.props;\n    if (onInteractionStateChange) {\n      onInteractionStateChange(interactionState);\n    }\n  };\n\n  const updateControllerOpts = () => {\n    if (thisRef.width && thisRef.height) {\n      controller.setOptions({\n        ...thisRef.props,\n        ...thisRef.props.viewState,\n        isInteractive: Boolean(thisRef.props.onViewStateChange || thisRef.props.onViewportChange),\n        onViewportChange: handleViewportChange,\n        onStateChange: handleInteractionStateChange,\n        eventManager,\n        width: thisRef.width,\n        height: thisRef.height\n      });\n    }\n  };\n\n  const onResize = ({width, height}) => {\n    thisRef.width = width;\n    thisRef.height = height;\n    updateControllerOpts();\n    thisRef.props.onResize({width, height});\n  };\n\n  useEffect(() => {\n    eventManager.setElement(eventCanvasRef.current);\n    // Register event handlers\n    eventManager.on({\n      pointerdown: onPointerDown.bind(thisRef),\n      pointermove: onPointerMove.bind(thisRef),\n      pointerup: onPointerUp.bind(thisRef),\n      pointerleave: onEvent.bind(thisRef, 'onMouseOut'),\n      click: onPointerClick.bind(thisRef),\n      anyclick: onPointerClick.bind(thisRef),\n      dblclick: onEvent.bind(thisRef, 'onDblClick'),\n      wheel: onEvent.bind(thisRef, 'onWheel'),\n      contextmenu: onEvent.bind(thisRef, 'onContextMenu')\n    });\n\n    // Clean up on unmount\n    return () => {\n      eventManager.destroy();\n    };\n  }, []);\n\n  useIsomorphicLayoutEffect(() => {\n    if (viewportUpdateRequested) {\n      // Perform deferred updates\n      handleViewportChange(...viewportUpdateRequested);\n    }\n    if (stateUpdateRequested) {\n      handleInteractionStateChange(stateUpdateRequested);\n    }\n  });\n\n  updateControllerOpts();\n\n  const {width, height, style, getCursor} = props;\n\n  const eventCanvasStyle = useMemo(\n    () => ({\n      position: 'relative',\n      ...style,\n      width,\n      height,\n      cursor: getCursor(thisRef.state)\n    }),\n    [style, width, height, getCursor, thisRef.state]\n  );\n\n  if (!viewportUpdateRequested || !thisRef._child) {\n    // Only rerender if no viewport update has been requested during render.\n    // Otherwise return the last rendered child, and invoke the callback when we're done.\n    thisRef._child = (\n      <MapContextProvider value={context}>\n        <div key=\"event-canvas\" ref={eventCanvasRef} style={eventCanvasStyle}>\n          <StaticMap\n            {...props}\n            width=\"100%\"\n            height=\"100%\"\n            style={null}\n            onResize={onResize}\n            ref={staticMapRef}\n          />\n        </div>\n      </MapContextProvider>\n    );\n  }\n\n  inRender = false;\n  return thisRef._child;\n});\n\nInteractiveMap.supported = StaticMap.supported;\nInteractiveMap.propTypes = propTypes;\nInteractiveMap.defaultProps = defaultProps;\n\nexport default InteractiveMap;\n"],"mappings":"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"}