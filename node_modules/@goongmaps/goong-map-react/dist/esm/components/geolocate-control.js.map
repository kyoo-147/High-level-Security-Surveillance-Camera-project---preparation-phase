{"version":3,"file":"geolocate-control.js","names":["React","useRef","useEffect","useState","useCallback","useMemo","PropTypes","document","mapboxgl","MapState","LINEAR_TRANSITION_PROPS","isGeolocationSupported","useMapControl","mapControlDefaultProps","mapControlPropTypes","noop","propTypes","Object","assign","className","string","style","object","label","disabledLabel","auto","bool","positionOptions","fitBoundsOptions","trackUserLocation","showUserLocation","showAccuracyCircle","onViewStateChange","func","onViewportChange","onGeolocate","defaultProps","enableHighAccuracy","timeout","maxZoom","getBounds","position","center","LngLat","coords","longitude","latitude","radius","accuracy","bounds","toBounds","_ne","lng","lat","_sw","setupMapboxGeolocateControl","context","props","geolocateButton","control","GeolocateControl","_container","createElement","_map","on","_getUIString","_setupUI","map","_geolocateButton","eventManager","options","_watchState","classList","add","remove","updateCamera","viewport","fitBounds","zoom","newViewState","mapState","viewState","getViewportProps","thisRef","containerRef","geolocateButtonRef","mapboxGeolocateControl","createMapboxGeolocateControl","supportsGeolocation","setSupportsGeolocation","then","result","current","_updateCamera","_clearWatch","triggerGeolocate","trigger","memo"],"sources":["../../../src/components/geolocate-control.js"],"sourcesContent":["import * as React from 'react';\nimport {useRef, useEffect, useState, useCallback, useMemo} from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport {document} from '../utils/globals';\nimport mapboxgl from '../utils/goongmap';\n\nimport MapState from '../utils/map-state';\nimport {LINEAR_TRANSITION_PROPS} from '../utils/map-controller';\nimport {isGeolocationSupported} from '../utils/geolocate-utils';\n\nimport useMapControl, {mapControlDefaultProps, mapControlPropTypes} from './use-map-control';\n\nconst noop = () => {};\n\nconst propTypes = Object.assign({}, mapControlPropTypes, {\n  // Custom className\n  className: PropTypes.string,\n  style: PropTypes.object,\n  // Custom label assigned to the control\n  label: PropTypes.string,\n  disabledLabel: PropTypes.string,\n  // Auto trigger instead of waiting for click\n  auto: PropTypes.bool,\n\n  // goong geolocate options\n  // https://docs.goong.io/javascript/markers/#geolocatecontrol\n  positionOptions: PropTypes.object,\n  fitBoundsOptions: PropTypes.object,\n  trackUserLocation: PropTypes.bool,\n  showUserLocation: PropTypes.bool,\n  showAccuracyCircle: PropTypes.bool,\n\n  // Callbacks fired when the user interacted with the map. The object passed to the callbacks\n  // contains viewport properties such as `longitude`, `latitude`, `zoom` etc.\n  onViewStateChange: PropTypes.func,\n  onViewportChange: PropTypes.func,\n\n  onGeolocate: PropTypes.func\n});\n\nconst defaultProps = Object.assign({}, mapControlDefaultProps, {\n  className: '',\n  label: 'Find My Location',\n  disabledLabel: 'Location Not Available',\n  auto: false,\n\n  // mapbox geolocate options\n  positionOptions: {enableHighAccuracy: false, timeout: 6000},\n  fitBoundsOptions: {maxZoom: 15},\n  trackUserLocation: false,\n  showUserLocation: true,\n  showAccuracyCircle: true,\n\n  onGeolocate: () => {}\n});\n\nfunction getBounds(position) {\n  const center = new mapboxgl.LngLat(position.coords.longitude, position.coords.latitude);\n  const radius = position.coords.accuracy;\n  const bounds = center.toBounds(radius);\n\n  return [\n    [bounds._ne.lng, bounds._ne.lat],\n    [bounds._sw.lng, bounds._sw.lat]\n  ];\n}\n\nfunction setupMapboxGeolocateControl(context, props, geolocateButton) {\n  const control = new mapboxgl.GeolocateControl(props);\n\n  // Dummy placeholders so that _setupUI does not crash\n  control._container = document.createElement('div');\n  control._map = {\n    on: () => {},\n    _getUIString: () => ''\n  };\n  control._setupUI(true);\n  control._map = context.map;\n\n  // replace mapbox internal UI elements with ours\n  control._geolocateButton = geolocateButton;\n\n  // From _setupUI\n  // when the camera is changed (and it's not as a result of the Geolocation Control) change\n  // the watch mode to background watch, so that the marker is updated but not the camera.\n  const {eventManager} = context;\n  if (control.options.trackUserLocation && eventManager) {\n    eventManager.on('panstart', () => {\n      if (control._watchState === 'ACTIVE_LOCK') {\n        control._watchState = 'BACKGROUND';\n        geolocateButton.classList.add('mapboxgl-ctrl-geolocate-background');\n        geolocateButton.classList.remove('mapboxgl-ctrl-geolocate-active');\n      }\n    });\n  }\n\n  control.on('geolocate', props.onGeolocate);\n  return control;\n}\n\nfunction updateCamera(position, {context, props}) {\n  const bounds = getBounds(position);\n  const {longitude, latitude, zoom} = context.viewport.fitBounds(bounds, props.fitBoundsOptions);\n\n  const newViewState = Object.assign({}, context.viewport, {\n    longitude,\n    latitude,\n    zoom\n  });\n  const mapState = new MapState(newViewState);\n  const viewState = Object.assign({}, mapState.getViewportProps(), LINEAR_TRANSITION_PROPS);\n\n  const onViewportChange = props.onViewportChange || context.onViewportChange || noop;\n  const onViewStateChange = props.onViewStateChange || context.onViewStateChange || noop;\n\n  // Call new style callback\n  onViewStateChange({viewState});\n\n  // Call old style callback\n  onViewportChange(viewState);\n}\n\nfunction GeolocateControl(props) {\n  const thisRef = useMapControl(props);\n  const {context, containerRef} = thisRef;\n  const geolocateButtonRef = useRef(null);\n  const [mapboxGeolocateControl, createMapboxGeolocateControl] = useState(null);\n  const [supportsGeolocation, setSupportsGeolocation] = useState(false);\n\n  useEffect(() => {\n    let control;\n\n    if (context.map) {\n      isGeolocationSupported().then(result => {\n        setSupportsGeolocation(result);\n\n        if (geolocateButtonRef.current) {\n          control = setupMapboxGeolocateControl(context, props, geolocateButtonRef.current);\n          // Overwrite Mapbox's GeolocateControl internal method\n          control._updateCamera = position => updateCamera(position, thisRef);\n          createMapboxGeolocateControl(control);\n        }\n      });\n    }\n\n    return () => {\n      if (control) {\n        control._clearWatch();\n      }\n    };\n  }, [context.map]);\n\n  const triggerGeolocate = useCallback(() => {\n    if (mapboxGeolocateControl) {\n      mapboxGeolocateControl.options = thisRef.props;\n      mapboxGeolocateControl.trigger();\n    }\n  }, [mapboxGeolocateControl]);\n\n  useEffect(() => {\n    if (props.auto) {\n      triggerGeolocate();\n    }\n  }, [mapboxGeolocateControl, props.auto]);\n\n  useEffect(() => {\n    if (mapboxGeolocateControl) {\n      // mapboxGeolocateControl._onZoom();\n    }\n  }, [context.viewport.zoom]);\n\n  const {className, label, disabledLabel, trackUserLocation} = props;\n\n  const style = useMemo(() => ({position: 'absolute', ...props.style}), [props.style]);\n\n  return (\n    <div style={style} className={className}>\n      <div key=\"geolocate-control\" className=\"mapboxgl-ctrl mapboxgl-ctrl-group\" ref={containerRef}>\n        <button\n          key=\"geolocate\"\n          className={`mapboxgl-ctrl-icon mapboxgl-ctrl-geolocate`}\n          ref={geolocateButtonRef}\n          disabled={!supportsGeolocation}\n          aria-pressed={!trackUserLocation}\n          type=\"button\"\n          title={supportsGeolocation ? label : disabledLabel}\n          aria-label={supportsGeolocation ? label : disabledLabel}\n          onClick={triggerGeolocate}\n        >\n          <span className=\"mapboxgl-ctrl-icon\" aria-hidden=\"true\" />\n        </button>\n      </div>\n    </div>\n  );\n}\n\nGeolocateControl.propTypes = propTypes;\nGeolocateControl.defaultProps = defaultProps;\n\nexport default React.memo(GeolocateControl);\n"],"mappings":"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"}