{"version":3,"file":"layer.js","names":["LAYER_TYPES","propTypes","type","PropTypes","oneOf","isRequired","id","string","source","beforeId","diffLayerStyles","map","props","prevProps","layout","paint","filter","minzoom","maxzoom","otherProps","moveLayer","prevLayout","key","deepEqual","setLayoutProperty","hasOwnProperty","undefined","prevPaint","setPaintProperty","setFilter","setLayerZoomRange","setLayerProperty","createLayer","style","_loaded","options","addLayer","updateLayer","assert","error","console","warn","layerCounter","Layer","context","useContext","MapContext","propsRef","useRef","useState","setStyleLoaded","useMemo","useEffect","forceUpdate","version","on","off","removeLayer","layer","getLayer","current"],"sources":["../../../src/components/layer.js"],"sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {useContext, useEffect, useMemo, useState, useRef} from 'react';\nimport * as PropTypes from 'prop-types';\nimport MapContext from './map-context';\nimport assert from '../utils/assert';\nimport deepEqual from '../utils/deep-equal';\n\nconst LAYER_TYPES = [\n  'fill',\n  'line',\n  'symbol',\n  'circle',\n  'fill-extrusion',\n  'raster',\n  'background',\n  'heatmap',\n  'hillshade',\n  'sky'\n];\n\nconst propTypes = {\n  type: PropTypes.oneOf(LAYER_TYPES).isRequired,\n  id: PropTypes.string,\n  source: PropTypes.string,\n  beforeId: PropTypes.string\n};\n\n/* eslint-disable complexity, max-statements */\nfunction diffLayerStyles(map, id, props, prevProps) {\n  const {layout = {}, paint = {}, filter, minzoom, maxzoom, beforeId, ...otherProps} = props;\n\n  if (beforeId !== prevProps.beforeId) {\n    map.moveLayer(id, beforeId);\n  }\n  if (layout !== prevProps.layout) {\n    const prevLayout = prevProps.layout || {};\n    for (const key in layout) {\n      if (!deepEqual(layout[key], prevLayout[key])) {\n        map.setLayoutProperty(id, key, layout[key]);\n      }\n    }\n    for (const key in prevLayout) {\n      if (!layout.hasOwnProperty(key)) {\n        map.setLayoutProperty(id, key, undefined);\n      }\n    }\n  }\n  if (paint !== prevProps.paint) {\n    const prevPaint = prevProps.paint || {};\n    for (const key in paint) {\n      if (!deepEqual(paint[key], prevPaint[key])) {\n        map.setPaintProperty(id, key, paint[key]);\n      }\n    }\n    for (const key in prevPaint) {\n      if (!paint.hasOwnProperty(key)) {\n        map.setPaintProperty(id, key, undefined);\n      }\n    }\n  }\n  if (!deepEqual(filter, prevProps.filter)) {\n    map.setFilter(id, filter);\n  }\n  if (minzoom !== prevProps.minzoom || maxzoom !== prevProps.maxzoom) {\n    map.setLayerZoomRange(id, minzoom, maxzoom);\n  }\n  for (const key in otherProps) {\n    if (!deepEqual(otherProps[key], prevProps[key])) {\n      map.setLayerProperty(id, key, otherProps[key]);\n    }\n  }\n}\n\nfunction createLayer(map, id, props) {\n  if (map.style && map.style._loaded) {\n    const options = {...props, id};\n    delete options.beforeId;\n\n    map.addLayer(options, props.beforeId);\n  }\n}\n\nfunction updateLayer(map, id, props, prevProps) {\n  assert(props.id === prevProps.id, 'layer id changed');\n  assert(props.type === prevProps.type, 'layer type changed');\n\n  try {\n    diffLayerStyles(map, id, props, prevProps);\n  } catch (error) {\n    console.warn(error); // eslint-disable-line\n  }\n}\n/* eslint-enable complexity, max-statements */\n\nlet layerCounter = 0;\n\nfunction Layer(props) {\n  const context = useContext(MapContext);\n  const propsRef = useRef({id: props.id, type: props.type});\n  const [, setStyleLoaded] = useState(0);\n\n  const id = useMemo(() => props.id || `jsx-layer-${layerCounter++}`, []);\n  const {map} = context;\n\n  useEffect(() => {\n    if (map) {\n      const forceUpdate = () => setStyleLoaded(version => version + 1);\n      map.on('styledata', forceUpdate);\n\n      return () => {\n        map.off('styledata', forceUpdate);\n        if (map.style && map.style._loaded) {\n          map.removeLayer(id);\n        }\n      };\n    }\n    return undefined;\n  }, [map]);\n\n  const layer = map && map.style && map.getLayer(id);\n  if (layer) {\n    updateLayer(map, id, props, propsRef.current);\n  } else {\n    createLayer(map, id, props);\n  }\n\n  // Store last rendered props\n  propsRef.current = props;\n\n  return null;\n}\n\nLayer.propTypes = propTypes;\n\nexport default Layer;\n"],"mappings":"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"}