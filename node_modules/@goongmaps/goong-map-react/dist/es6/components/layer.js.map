{"version":3,"file":"layer.js","names":["useContext","useEffect","useMemo","useState","useRef","PropTypes","MapContext","assert","deepEqual","LAYER_TYPES","propTypes","type","oneOf","isRequired","id","string","source","beforeId","diffLayerStyles","map","props","prevProps","layout","paint","filter","minzoom","maxzoom","otherProps","moveLayer","prevLayout","key","setLayoutProperty","hasOwnProperty","undefined","prevPaint","setPaintProperty","setFilter","setLayerZoomRange","setLayerProperty","createLayer","style","_loaded","options","addLayer","updateLayer","error","console","warn","layerCounter","Layer","context","propsRef","setStyleLoaded","forceUpdate","version","on","off","removeLayer","layer","getLayer","current"],"sources":["../../../src/components/layer.js"],"sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport {useContext, useEffect, useMemo, useState, useRef} from 'react';\nimport * as PropTypes from 'prop-types';\nimport MapContext from './map-context';\nimport assert from '../utils/assert';\nimport deepEqual from '../utils/deep-equal';\n\nconst LAYER_TYPES = [\n  'fill',\n  'line',\n  'symbol',\n  'circle',\n  'fill-extrusion',\n  'raster',\n  'background',\n  'heatmap',\n  'hillshade',\n  'sky'\n];\n\nconst propTypes = {\n  type: PropTypes.oneOf(LAYER_TYPES).isRequired,\n  id: PropTypes.string,\n  source: PropTypes.string,\n  beforeId: PropTypes.string\n};\n\n/* eslint-disable complexity, max-statements */\nfunction diffLayerStyles(map, id, props, prevProps) {\n  const {layout = {}, paint = {}, filter, minzoom, maxzoom, beforeId, ...otherProps} = props;\n\n  if (beforeId !== prevProps.beforeId) {\n    map.moveLayer(id, beforeId);\n  }\n  if (layout !== prevProps.layout) {\n    const prevLayout = prevProps.layout || {};\n    for (const key in layout) {\n      if (!deepEqual(layout[key], prevLayout[key])) {\n        map.setLayoutProperty(id, key, layout[key]);\n      }\n    }\n    for (const key in prevLayout) {\n      if (!layout.hasOwnProperty(key)) {\n        map.setLayoutProperty(id, key, undefined);\n      }\n    }\n  }\n  if (paint !== prevProps.paint) {\n    const prevPaint = prevProps.paint || {};\n    for (const key in paint) {\n      if (!deepEqual(paint[key], prevPaint[key])) {\n        map.setPaintProperty(id, key, paint[key]);\n      }\n    }\n    for (const key in prevPaint) {\n      if (!paint.hasOwnProperty(key)) {\n        map.setPaintProperty(id, key, undefined);\n      }\n    }\n  }\n  if (!deepEqual(filter, prevProps.filter)) {\n    map.setFilter(id, filter);\n  }\n  if (minzoom !== prevProps.minzoom || maxzoom !== prevProps.maxzoom) {\n    map.setLayerZoomRange(id, minzoom, maxzoom);\n  }\n  for (const key in otherProps) {\n    if (!deepEqual(otherProps[key], prevProps[key])) {\n      map.setLayerProperty(id, key, otherProps[key]);\n    }\n  }\n}\n\nfunction createLayer(map, id, props) {\n  if (map.style && map.style._loaded) {\n    const options = {...props, id};\n    delete options.beforeId;\n\n    map.addLayer(options, props.beforeId);\n  }\n}\n\nfunction updateLayer(map, id, props, prevProps) {\n  assert(props.id === prevProps.id, 'layer id changed');\n  assert(props.type === prevProps.type, 'layer type changed');\n\n  try {\n    diffLayerStyles(map, id, props, prevProps);\n  } catch (error) {\n    console.warn(error); // eslint-disable-line\n  }\n}\n/* eslint-enable complexity, max-statements */\n\nlet layerCounter = 0;\n\nfunction Layer(props) {\n  const context = useContext(MapContext);\n  const propsRef = useRef({id: props.id, type: props.type});\n  const [, setStyleLoaded] = useState(0);\n\n  const id = useMemo(() => props.id || `jsx-layer-${layerCounter++}`, []);\n  const {map} = context;\n\n  useEffect(() => {\n    if (map) {\n      const forceUpdate = () => setStyleLoaded(version => version + 1);\n      map.on('styledata', forceUpdate);\n\n      return () => {\n        map.off('styledata', forceUpdate);\n        if (map.style && map.style._loaded) {\n          map.removeLayer(id);\n        }\n      };\n    }\n    return undefined;\n  }, [map]);\n\n  const layer = map && map.style && map.getLayer(id);\n  if (layer) {\n    updateLayer(map, id, props, propsRef.current);\n  } else {\n    createLayer(map, id, props);\n  }\n\n  // Store last rendered props\n  propsRef.current = props;\n\n  return null;\n}\n\nLayer.propTypes = propTypes;\n\nexport default Layer;\n"],"mappings":"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"}