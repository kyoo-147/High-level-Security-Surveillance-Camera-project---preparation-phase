{"version":3,"file":"static-map.js","names":["React","useState","useRef","useCallback","useContext","useImperativeHandle","forwardRef","PropTypes","WebMercatorViewport","ResizeObserver","Mapbox","mapboxgl","checkVisibilityConstraints","MAPBOX_LIMITS","MapContext","MapContextProvider","useIsomorphicLayoutEffect","getTerrainElevation","TOKEN_DOC_URL","NO_TOKEN_WARNING","noop","getViewport","map","props","width","height","viewportProps","viewState","position","UNAUTHORIZED_ERROR_CODE","CONTAINER_STYLE","overflow","propTypes","Object","assign","oneOfType","number","string","onResize","func","disableTokenWarning","bool","visible","className","style","object","visibilityConstraints","defaultProps","NoTokenWarning","left","top","getRefHandles","mapboxRef","getMap","current","queryRenderedFeatures","geometry","options","StaticMap","ref","accessTokenValid","setTokenState","size","setSize","mapDivRef","containerRef","overlayRef","context","supported","undefined","mapbox","container","onError","evt","statusCode","error","status","console","setMap","resizeObserver","entries","contentRect","observe","finalize","disconnect","setProps","preventScroll","target","scrollTo","overlays","viewport","children","mapContainerStyle","mapStyle","visibility"],"sources":["../../../src/components/static-map.js"],"sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport * as React from 'react';\nimport {useState, useRef, useCallback, useContext, useImperativeHandle, forwardRef} from 'react';\nimport * as PropTypes from 'prop-types';\n\nimport WebMercatorViewport from 'viewport-mercator-project';\nimport ResizeObserver from 'resize-observer-polyfill';\n\nimport Mapbox from '../goong/goong';\nimport mapboxgl from '../utils/goongmap';\nimport {checkVisibilityConstraints} from '../utils/map-constraints';\nimport {MAPBOX_LIMITS} from '../utils/map-state';\nimport MapContext, {MapContextProvider} from './map-context';\nimport useIsomorphicLayoutEffect from '../utils/use-isomorphic-layout-effect';\nimport {getTerrainElevation} from '../utils/terrain';\n\n/* eslint-disable max-len */\nconst TOKEN_DOC_URL = 'https://visgl.github.io/react-map-gl/docs/get-started/mapbox-tokens';\nconst NO_TOKEN_WARNING = 'A valid API access token is required to use Mapbox data';\n/* eslint-disable max-len */\n\nfunction noop() {}\n\nexport function getViewport({map, props, width, height}) {\n  const viewportProps = {\n    ...props,\n    ...props.viewState,\n    width,\n    height\n  };\n  viewportProps.position = [0, 0, getTerrainElevation(map, viewportProps)];\n  return new WebMercatorViewport(viewportProps);\n}\n\nconst UNAUTHORIZED_ERROR_CODE = 401;\n\nconst CONTAINER_STYLE = {\n  position: 'absolute',\n  width: '100%',\n  height: '100%',\n  overflow: 'hidden'\n};\n\nconst propTypes = Object.assign({}, Mapbox.propTypes, {\n  /** The dimensions of the map **/\n  width: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n  height: PropTypes.oneOfType([PropTypes.number, PropTypes.string]),\n\n  /** Callback when map size changes **/\n  onResize: PropTypes.func,\n  /** Hide invalid token warning even if request fails */\n  disableTokenWarning: PropTypes.bool,\n  /** Whether the map is visible */\n  visible: PropTypes.bool,\n  /** Custom class name for the map */\n  className: PropTypes.string,\n  /** Custom CSS for the container */\n  style: PropTypes.object,\n\n  /** Advanced features */\n  // Contraints for displaying the map. If not met, then the map is hidden.\n  // Experimental! May be changed in minor version updates.\n  visibilityConstraints: PropTypes.object\n});\n\nconst defaultProps = Object.assign({}, Mapbox.defaultProps, {\n  disableTokenWarning: false,\n  visible: true,\n  onResize: noop,\n  className: '',\n  style: null,\n  visibilityConstraints: MAPBOX_LIMITS\n});\n\nfunction NoTokenWarning() {\n  const style = {\n    position: 'absolute',\n    left: 0,\n    top: 0\n  };\n  return (\n    <div\n      key=\"warning\"\n      id=\"no-token-warning\"\n      // @ts-ignore\n      style={style}\n    >\n      <h3 key=\"header\">{NO_TOKEN_WARNING}</h3>\n      <div key=\"text\">For information on setting up your basemap, read</div>\n      <a key=\"link\" href={TOKEN_DOC_URL}>\n        Note on Map Tokens\n      </a>\n    </div>\n  );\n}\n\nfunction getRefHandles(mapboxRef) {\n  return {\n    getMap: () => mapboxRef.current && mapboxRef.current.getMap(),\n    queryRenderedFeatures: (geometry, options = {}) => {\n      const map = mapboxRef.current && mapboxRef.current.getMap();\n      return map && map.queryRenderedFeatures(geometry, options);\n    }\n  };\n}\n\nconst StaticMap = forwardRef((props, ref) => {\n  const [accessTokenValid, setTokenState] = useState(true);\n  const [size, setSize] = useState({width: 0, height: 0});\n  const mapboxRef = useRef(null);\n  const mapDivRef = useRef(null);\n  const containerRef = useRef(null);\n  const overlayRef = useRef(null);\n  const context = useContext(MapContext);\n\n  useIsomorphicLayoutEffect(() => {\n    if (!StaticMap.supported()) {\n      return undefined;\n    }\n\n    // Initialize\n    const mapbox = new Mapbox({\n      ...props,\n      ...size,\n      mapboxgl, // Handle to mapbox-gl library\n      container: mapDivRef.current,\n      onError: evt => {\n        const statusCode = (evt.error && evt.error.status) || evt.status;\n        if (statusCode === UNAUTHORIZED_ERROR_CODE && accessTokenValid) {\n          // Mapbox throws unauthorized error - invalid token\n          console.error(NO_TOKEN_WARNING); // eslint-disable-line\n          setTokenState(false);\n        }\n        props.onError(evt);\n      }\n    });\n    mapboxRef.current = mapbox;\n\n    if (context && context.setMap) {\n      context.setMap(mapbox.getMap());\n    }\n\n    const resizeObserver = new ResizeObserver(entries => {\n      if (entries[0].contentRect) {\n        const {width, height} = entries[0].contentRect;\n        setSize({width, height});\n        props.onResize({width, height});\n      }\n    });\n    resizeObserver.observe(containerRef.current);\n\n    // Clean up\n    return () => {\n      mapbox.finalize();\n      mapboxRef.current = null;\n      resizeObserver.disconnect();\n    };\n  }, []);\n\n  useIsomorphicLayoutEffect(() => {\n    if (mapboxRef.current) {\n      mapboxRef.current.setProps({...props, ...size});\n    }\n  });\n\n  const map = mapboxRef.current && mapboxRef.current.getMap();\n\n  // External apps can call methods via ref\n  // Note: this is not a recommended pattern in React FC - Keeping for backward compatibility\n  useImperativeHandle(ref, () => getRefHandles(mapboxRef), []);\n\n  const preventScroll = useCallback(({target}) => {\n    if (target === overlayRef.current) {\n      target.scrollTo(0, 0);\n    }\n  }, []);\n\n  const overlays = map && (\n    <MapContextProvider\n      value={{\n        ...context,\n        viewport: context.viewport || getViewport({map, props, ...size}),\n        map,\n        container: context.container || containerRef.current\n      }}\n    >\n      <div\n        key=\"map-overlays\"\n        className=\"overlays\"\n        ref={overlayRef}\n        // @ts-ignore\n        style={CONTAINER_STYLE}\n        onScroll={preventScroll}\n      >\n        {props.children}\n      </div>\n    </MapContextProvider>\n  );\n\n  const {className, width, height, style, visibilityConstraints} = props;\n  const mapContainerStyle = Object.assign({position: 'relative'}, style, {\n    width,\n    height\n  });\n\n  const visible =\n    props.visible && checkVisibilityConstraints(props.viewState || props, visibilityConstraints);\n\n  const mapStyle = Object.assign({}, CONTAINER_STYLE, {\n    visibility: visible ? 'inherit' : 'hidden'\n  });\n\n  return (\n    <div\n      key=\"map-container\"\n      ref={containerRef}\n      // @ts-ignore\n      style={mapContainerStyle}\n    >\n      <div\n        key=\"map-mapbox\"\n        ref={mapDivRef}\n        // @ts-ignore\n        style={mapStyle}\n        className={className}\n      />\n      {overlays}\n      {!accessTokenValid && !props.disableTokenWarning && <NoTokenWarning />}\n    </div>\n  );\n});\n\nStaticMap.supported = () => mapboxgl && mapboxgl.supported();\nStaticMap.propTypes = propTypes;\nStaticMap.defaultProps = defaultProps;\n\nexport default StaticMap;\n"],"mappings":"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"}