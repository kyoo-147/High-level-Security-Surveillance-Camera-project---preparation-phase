{"version":3,"file":"source.js","names":["React","useContext","useEffect","useMemo","useState","useRef","cloneElement","PropTypes","MapContext","assert","deepEqual","propTypes","type","string","isRequired","id","sourceCounter","createSource","map","props","style","_loaded","options","children","addSource","getSource","updateSource","source","prevProps","changedKey","changedKeyCount","key","setData","data","updateImage","url","coordinates","setCoordinates","setUrl","setTiles","tiles","console","warn","Source","context","propsRef","setStyleLoaded","forceUpdate","version","on","off","requestAnimationFrame","removeSource","undefined","current","Children","child"],"sources":["../../../src/components/source.js"],"sourcesContent":["// Copyright (c) 2015 Uber Technologies, Inc.\n\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport * as React from 'react';\nimport {useContext, useEffect, useMemo, useState, useRef} from 'react';\nimport {cloneElement} from 'react';\nimport * as PropTypes from 'prop-types';\nimport MapContext from './map-context';\nimport assert from '../utils/assert';\nimport deepEqual from '../utils/deep-equal';\n\nconst propTypes = {\n  type: PropTypes.string.isRequired,\n  id: PropTypes.string\n};\n\nlet sourceCounter = 0;\n\nfunction createSource(map, id, props) {\n  if (map.style && map.style._loaded) {\n    const options = {...props};\n    delete options.id;\n    delete options.children;\n    map.addSource(id, options);\n    return map.getSource(id);\n  }\n  return null;\n}\n\n/* eslint-disable complexity */\nfunction updateSource(source, props, prevProps) {\n  assert(props.id === prevProps.id, 'source id changed');\n  assert(props.type === prevProps.type, 'source type changed');\n\n  let changedKey = '';\n  let changedKeyCount = 0;\n\n  for (const key in props) {\n    if (key !== 'children' && key !== 'id' && !deepEqual(prevProps[key], props[key])) {\n      changedKey = key;\n      changedKeyCount++;\n    }\n  }\n\n  if (!changedKeyCount) {\n    return;\n  }\n\n  const {type} = props;\n  if (type === 'geojson') {\n    source.setData(props.data);\n  } else if (type === 'image') {\n    source.updateImage({url: props.url, coordinates: props.coordinates});\n  } else if (\n    (type === 'canvas' || type === 'video') &&\n    changedKeyCount === 1 &&\n    changedKey === 'coordinates'\n  ) {\n    source.setCoordinates(props.coordinates);\n  } else if (type === 'vector' && source.setUrl) {\n    // Added in 1.12.0:\n    // vectorTileSource.setTiles\n    // vectorTileSource.setUrl\n    switch (changedKey) {\n      case 'url':\n        source.setUrl(props.url);\n        break;\n      case 'tiles':\n        source.setTiles(props.tiles);\n        break;\n      default:\n    }\n  } else {\n    // eslint-disable-next-line\n    console.warn(`Unable to update <Source> prop: ${changedKey}`);\n  }\n}\n/* eslint-enable complexity */\n\nfunction Source(props) {\n  const context = useContext(MapContext);\n  const propsRef = useRef({id: props.id, type: props.type});\n  const [, setStyleLoaded] = useState(0);\n\n  const id = useMemo(() => props.id || `jsx-source-${sourceCounter++}`, []);\n  const {map} = context;\n\n  useEffect(() => {\n    if (map) {\n      const forceUpdate = () => setStyleLoaded(version => version + 1);\n      map.on('styledata', forceUpdate);\n\n      return () => {\n        map.off('styledata', forceUpdate);\n        /* global requestAnimationFrame */\n        // Do not remove source immediately because the\n        // dependent <Layer>s' componentWillUnmount() might not have been called\n        // Removing source before dependent layers will throw error\n        // TODO - find a more robust solution\n        requestAnimationFrame(() => {\n          if (map.style && map.style._loaded && map.getSource(id)) {\n            map.removeSource(id);\n          }\n        });\n      };\n    }\n    return undefined;\n  }, [map, id]);\n\n  let source = map && map.style && map.getSource(id);\n  if (source) {\n    updateSource(source, props, propsRef.current);\n  } else {\n    source = createSource(map, id, props);\n  }\n  propsRef.current = props;\n\n  return (\n    (source &&\n      React.Children.map(\n        props.children,\n        child =>\n          child &&\n          cloneElement(child, {\n            source: id\n          })\n      )) ||\n    null\n  );\n}\n\nSource.propTypes = propTypes;\nexport default Source;\n"],"mappings":"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"}